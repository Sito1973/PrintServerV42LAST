
FROM node:20-alpine

# Saltamos la instalación de dependencias del sistema por problemas de seccomp
# curl está disponible en node:20-alpine por defecto
# healthcheck usará wget nativo de node si es necesario

# Crear directorio de trabajo
WORKDIR /app

# Copiar package.json y package-lock.json
COPY package*.json ./

# Instalar todas las dependencias (incluyendo dev para el build)
RUN npm ci --no-audit

# Copiar código fuente
COPY . .

# Compilar aplicación
RUN npm run build

# Verificar que los archivos fueron generados correctamente
RUN ls -la dist/ && echo "Build completed successfully"

# NO eliminar drizzle-kit - crear una copia del node_modules completo
# Solo eliminar las dependencias más pesadas manualmente
RUN rm -rf node_modules/@types/node \
    node_modules/@types/react \
    node_modules/@types/express \
    node_modules/typescript \
    node_modules/tsx \
    node_modules/@vitejs \
    node_modules/vite \
    node_modules/esbuild \
    || true

# Crear archivo .env con configuración por defecto
RUN echo 'NODE_ENV=production\nPORT=3000\nHOST=0.0.0.0' > /app/.env

# Variables de entorno
ENV NODE_ENV=production
ENV PORT=3000
ENV HOST=0.0.0.0

# Exponer puerto 3000
EXPOSE 3000

# Healthcheck usando node (sin curl)
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD node -e "const http=require('http');const req=http.request({hostname:'localhost',port:3000,timeout:5000},res=>process.exit(res.statusCode===200?0:1));req.on('error',()=>process.exit(1));req.end();" || exit 1

# Script de inicio simplificado - SIN bucles de migración
RUN echo '#!/bin/sh\n\
set -e\n\
echo "🚀 Iniciando aplicación en Easypanel..."\n\
\n\
# Verificar variables de entorno requeridas\n\
if [ -z "$DATABASE_URL" ]; then\n\
  echo "❌ Error: DATABASE_URL no está configurada"\n\
  exit 1\n\
fi\n\
\n\
echo "✅ DATABASE_URL configurada"\n\
echo "✅ PORT: $PORT"\n\
\n\
# Ejecutar migraciones UNA SOLA VEZ\n\
echo "🔄 Aplicando migraciones (una vez)..."\n\
npm run db:push || echo "⚠️ Advertencia: Error en migraciones"\n\
\n\
# Iniciar servidor en puerto 3000 directamente\n\
echo "🎯 Iniciando servidor en puerto $PORT..."\n\
exec node dist/index.js' > /app/start.sh && chmod +x /app/start.sh

# Comando de inicio
CMD ["/app/start.sh"]
